name: Deploy Laravel Project to FTP

on:
  push:
    branches:
      - main

jobs:
  ftp-deploy:
    runs-on: ubuntu-latest
    steps:
    
    # 1. Adım: Kodu checkout et
    - name: Check out repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Git geçmişini tam al ki sadece değişenleri daha iyi anlasın

    # 2. Adım: PHP Ortamını Kur
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, xml, ctype, json, tokenizer, dom, pdo, pdo_mysql
        tools: composer

    # 2.5 Adım: Laravel için gerekli dizinleri oluştur
    - name: Create necessary Laravel directories
      run: |
        mkdir -p bootstrap/cache
        mkdir -p storage/framework/{sessions,views,cache}
        mkdir -p storage/logs

    # 3. Adım: Composer bağımlılıklarını kur (Optimize edildi)
    # --prefer-dist: Zip olarak indirir, daha hızlıdır.
    - name: Install Composer Dependencies
      run: composer install --no-interaction --no-dev --optimize-autoloader --prefer-dist

    # 4. Adım: Node.js (NPM için) Ortamını Kur
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # 5. Adım: NPM bağımlılıklarını kur
    - name: Install NPM Dependencies
      run: npm install

    # 6. Adım: CSS/JS dosyalarını derle
    - name: Build Assets (Vite)
      run: npm run build

    # 7. Adım: FTP ile Sunucuya Yükle
    - name: Deploy to FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: ${{ secrets.SERVER_PATH }}
        protocol: ftp
        port: 21
        
        # DÜZELTME 1: Timeout süresi artırıldı
        # 30000 (30sn) -> 1800000 (30 dakika)
        timeout: 1800000 
        
        # Sadece değişenleri yükle
        dangerous-clean-slate: false
        
        # DÜZELTME 2: Exclude listesine 'tests' ve gereksizler eklendi
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/tests/**
          **/phpunit.xml
          **/README.md
          .env
          .env.example
          .github/**
          .editorconfig
          storage/framework/sessions/*
          storage/framework/views/*
          storage/framework/cache/data/*
          storage/logs/*
          public/storage
          docker-compose.yml
          .dockerignore